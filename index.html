<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>monaco</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs/loader.min.js"></script>
    <style>
html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background-color: #0B0914 !important;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #E3D7FF;
}

/* ===== TAB BAR ===== */
#tab-bar {
    background-color: transparent;
    padding: 0px 0px 4px 2px;
    display: flex;
    align-items: center;
    gap: 2px;
    border-bottom: 0;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1000;
    overflow-x: auto;
    white-space: nowrap;
    scrollbar-width: thin;
    scrollbar-color: #8B5CF6 #1A152B;
    scroll-behavior: smooth;
}

#tab-bar::-webkit-scrollbar {
    height: 6px;
}
#tab-bar::-webkit-scrollbar-track {
    background: transparent;
}
#tab-bar::-webkit-scrollbar-thumb {
    background: rgba(139,92,246,0.3);
    border-radius: 3px;
}
#tab-bar::-webkit-scrollbar-thumb:hover {
    background: rgba(159,107,255,0.5);
}

/* ===== TABS ===== */
.tab {
    background-color: transparent;
    color: #CFC2FF;
    padding: 6px 18px;
    border-radius: 8px;
    cursor: default;
    user-select: none;
    font-size: 13px;
    font-weight: 500;
    transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    margin: 3px 5px 3px 0;
    min-height: 24px;
    line-height: 1.2;
    letter-spacing: 0.2px;
}

.tab.active {
    background-color: #1A152B;
    color: #EDE6FF;
    transform: scale(1.04);
    border: 1px solid #4C3B7E;
}

.tab:hover {
    background-color: #251A3A;
    color: #FFFFFF;
}

.tab:active {
    transform: scale(0.97);
}

/* ===== CLOSE BUTTON ===== */
.close-btn {
    background: none;
    border: none;
    color: #BBAAFF;
    font-size: 15px;
    cursor: pointer;
    padding: 0;
    width: 18px;
    height: 18px;
    margin-left: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: color 0.15s ease, background-color 0.15s ease;
}
.close-btn:hover {
    color: #FF4DA6;
    background-color: rgba(255, 77, 166, 0.12);
}

/* ===== NEW TAB BUTTON ===== */
#new-tab-btn {
    background-color: transparent;
    color: #A68AFF;
    border: none;
    padding: 8px 14px;
    border-radius: 14px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
    flex-shrink: 0;
    min-height: 34px;
    display: flex;
    align-items: center;
    gap: 6px;
}
#new-tab-btn:hover {
    background-color: rgba(139,92,246,0.15);
    color: #EDE6FF;
}
#new-tab-btn:active {
    transform: scale(0.97);
}

/* ===== EDITOR ===== */
#container {
    width: 100%;
    height: calc(100vh - 44px);
    position: absolute;
    top: 36px;
    left: 0;
    background-color: transparent;
}

.editor-container {
    width: 100%;
    height: 100%;
    position: absolute;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease-in-out;
}
.editor-container.active {
    opacity: 1;
    pointer-events: auto;
}

/* ===== RENAME INPUT ===== */
.rename-input {
    background-color: rgba(139,92,246,0.08);
    color: #FFFFFF;
    border: 1px solid #4C3B7E;
    padding: 7px 10px;
    font-size: 14px;
    border-radius: 8px;
    width: 100px;
    height: 21px;
    transition: opacity 0.15s ease-in-out;
    opacity: 0;
}
.rename-input:focus {
    opacity: 1;
}

/* ===== MONACO UI ===== */
.monaco-editor .suggest-widget {
    opacity: 0;
    transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
    transform: translateY(-4px);
}
.monaco-editor .suggest-widget.visible {
    opacity: 1;
    transform: translateY(0);
}

.monaco-editor .suggest-widget .results-container::-webkit-scrollbar-thumb {
    background: rgba(139,92,246,0.4);
}
</style>
</head>
<body>
    <div id="tab-bar">
        <button id="new-tab-btn">+</button>
    </div>
    <div id="container"></div>
    <script>
        require.config({
            paths: {
                'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.43.0/min/vs'
            }
        });

        require(['vs/editor/editor.main'], function () {
            monaco.languages.register({ id: 'lua' });

            monaco.languages.setMonarchTokensProvider('lua', {
                keywords: [
                    'and', 'break', 'do', 'else', 'elseif', 'end', 'false', 'for',
                    'function', 'goto', 'if', 'in', 'local', 'nil', 'not', 'or', 'repeat',
                    'return', 'then', 'true', 'until', 'while'
                ],
                builtins: [
                    'print', 'require', 'ipairs', 'pairs', 'next', 'type', 'tostring',
                    'tonumber', 'table.insert', 'table.remove', 'table.concat',
                    'string.len', 'string.sub', 'string.format', 'string.match',
                    'string.gmatch', 'string.gsub', 'math.floor', 'math.ceil',
                    'math.random', 'os.time', 'os.date', 'assert', 'error', 'pcall'
                ],
                globals: [
                    '_G', '_ENV', 'self'
                ],
                tokenizer: {
                    root: [
                        [/::[a-zA-Z_]\w*::/, 'label'],
                        [/_[A-Z]+/, { cases: { '@globals': 'variable.global', '@default': 'identifier' } }],
                        [/[a-zA-Z_]\w*/, {
                            cases: {
                                '@keywords': 'keyword',
                                '@builtins': 'support.function',
                                '@globals': 'variable.global',
                                '@default': 'identifier'
                            }
                        }],
                        [/\d+(\.\d+)?([eE][\-+]?\d+)?/, 'number'],
                        [/0[xX][0-9a-fA-F]+/, 'number.hex'],
                        [/0[bB][01]+/, 'number.binary'],
                        [/"/, 'string.quote', '@string_double'],
                        [/'/, 'string.quote', '@string_single'],
                        [/\[\[|\[=+?\[/, 'string.quote', '@string_long'],
                        [/--\[=*\[/, 'comment', '@comment_brackets'],
                        [/--(?:FIXME|TODO|NOTE).*$/, 'comment.special'],
                        [/--.*$/, 'comment'],
                        [/[+\-*/%^#=~<>!&|]+|\/\/|==|~=|<=|>=|\.\.|\.\.\./, 'operator'],
                        [/[{}()\[\],;]/, 'delimiter']
                    ],
                    string_double: [
                        [/[^\\"]+/, 'string'],
                        [/\\\\|\\[bfnrt"\\]|\\u{[0-9A-Fa-f]+}/, 'string.escape'],
                        [/"/, 'string.quote', '@pop'],
                        [/\\./, 'string.escape.invalid']
                    ],
                    string_single: [
                        [/[^\\']+/, 'string'],
                        [/\\\\|\\[bfnrt'\\]|\\u{[0-9A-Fa-f]+}/, 'string.escape'],
                        [/'/, 'string.quote', '@pop'],
                        [/\\./, 'string.escape.invalid']
                    ],
                    string_long: [
                        [/[^$$\]]+/, 'string'],
                        [/$$=*\$$/, 'string.quote', '@pop'],
                        [/\\./, 'string.escape']
                    ],
                    comment_brackets: [
                        [/[^$$\]]+/, 'comment'],
                        [/$$=*\$$/, 'comment', '@pop'],
                        [/\\./, 'string.escape']
                    ]
                }
            });

            monaco.editor.defineTheme('smooth-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [
                    { token: 'comment', foreground: '5C966C', fontStyle: 'italic' },
                    { token: 'comment.special', foreground: '6AB880', fontStyle: 'italic bold' },
                    { token: 'keyword', foreground: 'c9c9c9', fontStyle: 'bold' },
                    { token: 'support.function', foreground: '8AA8D1' },
                    { token: 'identifier', foreground: 'c9c9c9' },
                    { token: 'variable.global', foreground: 'B5D9F0' },
                    { token: 'label', foreground: 'DDBA7A', fontStyle: 'bold' },
                    { token: 'string', foreground: 'C1A88B', fontStyle: 'italic' },
                    { token: 'string.long', foreground: 'C1A88B', fontStyle: 'italic' },
                    { token: 'number', foreground: 'A9C9A9' },
                    { token: 'number.hex', foreground: '9AAE9A' },
                    { token: 'number.binary', foreground: '94A894' },
                    { token: 'operator', foreground: 'ABB2BF' },
                    { token: 'delimiter', foreground: '88908B' },
                ],
                colors: {
                    'editor.background': '#00000000',
                    'editor.foreground': '#FFFFFF',
                    'editor.lineHighlightBackground': '#2a2a2a',
                    'editorCursor.foreground': '#FFFFFF',
                    'editor.selectionBackground': '#3E445180',
                    'editorLineNumber.foreground': '#5C6370',
                    'editorLineNumber.activeForeground': '#ABB2BF',
                    'editorSuggestWidget.background': '#1a1a1a',
                    'editorSuggestWidget.foreground': '#FFFFFF',
                    'editorSuggestWidget.highlightForeground': '#999966',
                    'editorHoverWidget.background': '#21252B',
                    'editorHoverWidget.foreground': '#FFFFFF',
                    'scrollbar.shadow': 'none',
                    'scrollbarSlider.background': '#74747450'
                }
            });

            monaco.languages.registerCompletionItemProvider('lua', {
                triggerCharacters: ['.', ':', '='],
                provideCompletionItems: function (model, position) {
                    const word = model.getWordUntilPosition(position);
                    const range = {
                        startLineNumber: position.lineNumber,
                        endLineNumber: position.lineNumber,
                        startColumn: word.startColumn,
                        endColumn: word.endColumn
                    };

                    const text = model.getValue();
                    const lines = text.split('\n');
                    const variableSuggestions = [];

const luaSnippets = [
    {
        label: 'function',
        insertText: 'function ${1:name}(${2:params})\n\t$0\nend',
        kind: monaco.languages.CompletionItemKind.Snippet,
        documentation: 'Function declaration',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        range: range
    },
    {
        label: 'if',
        insertText: 'if ${1:condition} then\n\t$0\nend',
        kind: monaco.languages.CompletionItemKind.Snippet,
        documentation: 'If statement',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        range: range
    },
    {
        label: 'ifelse',
        insertText: 'if ${1:condition} then\n\t$0\nelse\n\t\nend',
        kind: monaco.languages.CompletionItemKind.Snippet,
        documentation: 'If-else statement',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        range: range
    },
    {
        label: 'for',
        insertText: 'for ${1:i}=${2:1}, ${3:10} do\n\t$0\nend',
        kind: monaco.languages.CompletionItemKind.Snippet,
        documentation: 'For loop',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        range: range
    },
    {
        label: 'while',
        insertText: 'while ${1:condition} do\n\t$0\nend',
        kind: monaco.languages.CompletionItemKind.Snippet,
        documentation: 'While loop',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        range: range
    },
    {
        label: 'table',
        insertText: 'local ${1:tableName} = {}\n$0',
        kind: monaco.languages.CompletionItemKind.Snippet,
        documentation: 'Table declaration',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        range: range
    },
    {
        label: 'then',
        insertText: 'then',
        kind: monaco.languages.CompletionItemKind.Keyword,
        documentation: 'Then clause for if statements',
        range: range
    },
    {
        label: 'true',
        insertText: 'true',
        kind: monaco.languages.CompletionItemKind.Keyword,
        documentation: 'Boolean true',
        range: range
    },
    {
        label: 'false',
        insertText: 'false',
        kind: monaco.languages.CompletionItemKind.Keyword,
        documentation: 'Boolean false',
        range: range
    },
    {
        label: 'else',
        insertText: 'else',
        kind: monaco.languages.CompletionItemKind.Keyword,
        documentation: 'Else clause',
        range: range
    },
    {
        label: 'elseif',
        insertText: 'elseif ${1:condition} then\n\t$0',
        kind: monaco.languages.CompletionItemKind.Snippet,
        documentation: 'Elseif clause',
        insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
        range: range
    },
    {
        label: 'end',
        insertText: 'end',
        kind: monaco.languages.CompletionItemKind.Keyword,
        documentation: 'End block',
        range: range
    }
];

                    const localVarRegex = /^\s*local\s+([a-zA-Z_]\w*)\s*=/;
                    const globalVarRegex = /^\s*([a-zA-Z_]\w*)\s*=\s*(?!\s*(nil|false|true|function))/;

                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (line.startsWith('--')) continue;
                        let match;
                        if (match = line.match(localVarRegex)) {
                            const varName = match[1];
                            if (!variableSuggestions.some(s => s.label === varName)) {
                                variableSuggestions.push({
                                    label: varName,
                                    kind: monaco.languages.CompletionItemKind.Variable,
                                    documentation: `Local variable: ${varName}`,
                                    insertText: varName,
                                    range: range
                                });
                            }
                        }
                        if (match = line.match(globalVarRegex)) {
                            const varName = match[1];
                            const builtins = new Set(['print', 'warn', 'error', 'debug', 'getgenv', 'getrenv', 'require']);
                            if (!builtins.has(varName) && !variableSuggestions.some(s => s.label === varName)) {
                                variableSuggestions.push({
                                    label: varName,
                                    kind: monaco.languages.CompletionItemKind.Variable,
                                    documentation: `Global variable: ${varName}`,
                                    insertText: varName,
                                    range: range
                                });
                            }
                        }
                    }

                    const existingSuggestions = [
                        {
                            label: 'print(value)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Print to console',
                            insertText: 'print($0)',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'warn(message)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Print warning message',
                            insertText: 'warn("$0")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'error(message, level)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Throw runtime error',
                            insertText: 'error("$1", $2)',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'debug.getconstant(func, index)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Get constant from function',
                            insertText: 'debug.getconstant(${1:func}, ${2:index})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'debug.getconstants(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Get all constants in function',
                            insertText: 'debug.getconstants(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'debug.getproto(func, index)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Get upvalue from function',
                            insertText: 'debug.getproto(${1:func}, ${2:index})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'debug.getprotos(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Get all prototypes of function',
                            insertText: 'debug.getprotos(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'debug.getstack(thread, level)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Get stack trace',
                            insertText: 'debug.getstack(${1:thread}, ${2:level})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'debug.getupvalue(func, index)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Get upvalue by index',
                            insertText: 'debug.getupvalue(${1:func}, ${2:index})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'debug.getupvalues(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Get all upvalues',
                            insertText: 'debug.getupvalues(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'debug.setconstant(func, index, value)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Modify function constant',
                            insertText: 'debug.setconstant(${1:func}, ${2:index}, ${3:value})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'debug.setstack(thread, level, var)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Modify stack value',
                            insertText: 'debug.setstack(${1:thread}, ${2:level}, ${3:var})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'debug.setupvalue(func, index, value)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Modify upvalue',
                            insertText: 'debug.setupvalue(${1:func}, ${2:index}, ${3:value})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'checkcaller()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Check if script is calling',
                            insertText: 'checkcaller()',
                            range: range
                        },
                        {
                            label: 'clonefunction(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Clone a function',
                            insertText: 'clonefunction(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'getfunctionhash(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Get hash of function',
                            insertText: 'getfunctionhash(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'hookfunction(target, replacement)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Hook a function',
                            insertText: 'hookfunction(${1:target}, ${2:replacement})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'hookmetamethod(table, index, func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Hook metamethod',
                            insertText: 'hookmetamethod(${1:table}, "${2:__index}", ${3:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'iscclosure(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Check if C closure',
                            insertText: 'iscclosure(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'isexecutorclosure(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Check if executor closure',
                            insertText: 'isexecutorclosure(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'islclosure(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Check if Lua closure',
                            insertText: 'islclosure(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'newcclosure(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Create C closure',
                            insertText: 'newcclosure(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'restorefunction(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Restore hooked function',
                            insertText: 'restorefunction(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'crypt.base64encode(data)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Base64 encode',
                            insertText: 'crypt.base64encode("${1:data}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'crypt.base64decode(data)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Base64 decode',
                            insertText: 'crypt.base64decode("${1:data}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'Drawing.new(type)',
                            kind: monaco.languages.CompletionItemKind.Constructor,
                            documentation: 'Create a Drawing object',
                            insertText: 'Drawing.new("${1:Square}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'cleardrawcache()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Clear drawing cache',
                            insertText: 'cleardrawcache()',
                            range: range
                        },
                        {
                            label: 'getrenderproperty(obj, prop)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Get render property',
                            insertText: 'getrenderproperty(${1:obj}, "${2:Visible}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'isrenderobj(obj)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Check if render object',
                            insertText: 'isrenderobj(${1:obj})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'setrenderproperty(obj, prop, value)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Set render property',
                            insertText: 'setrenderproperty(${1:obj}, "${2:Color}", ${3:value})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'getgc(tables)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Get GC objects',
                            insertText: 'getgc(${1:true})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'getgenv()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets global environment',
                            insertText: 'getgenv()',
                            range: range
                        },
                        {
                            label: 'getreg()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets registry',
                            insertText: 'getreg()',
                            range: range
                        },
                        {
                            label: 'getrenv()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets roblox environment',
                            insertText: 'getrenv()',
                            range: range
                        },
                        {
                            label: 'filtergc(filterType, filterOptions, returnOne)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Filters GC objects',
                            insertText: 'filtergc(function(v) return ${1:true} end)',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'appendfile(path, content)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Append to file',
                            insertText: 'appendfile("${1:path}", "${2:content}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'delfile(path)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Deletes file',
                            insertText: 'delfile("${1:path}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'delfolder(path)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Deletes folder',
                            insertText: 'delfolder("${1:path}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'getcustomasset(path)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets custom asset URL',
                            insertText: 'getcustomasset("${1:path}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'isfile(path)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Checks if file exists',
                            insertText: 'isfile("${1:path}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'isfolder(path)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Checks if folder exists',
                            insertText: 'isfolder("${1:path}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'listfiles(path)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Lists files in directory',
                            insertText: 'listfiles("${1:path}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'loadfile(path)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Loads Lua file',
                            insertText: 'loadfile("${1:path}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'makefolder(path)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Creates folder',
                            insertText: 'makefolder("${1:path}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'readfile(path)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Reads file content',
                            insertText: 'readfile("${1:path}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'writefile(path, content)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Writes to file',
                            insertText: 'writefile("${1:path}", "${2:content}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'cloneref(instance)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Clones instance reference',
                            insertText: 'cloneref(${1:inst})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'compareinstances(a, b)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Compares two instances',
                            insertText: 'compareinstances(${1:a}, ${2:b})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                                                {
                            label: 'compareclosures(a, b)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Compares two functions',
                            insertText: 'compareclosures(${1:a}, ${2:b})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'fireclickdetector(clickDetector, distance)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Fires ClickDetector',
                            insertText: 'fireclickdetector(${1:ClickDetector}, ${2:0})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'fireproximityprompt(prompt, action)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Fires ProximityPrompt',
                            insertText: 'fireproximityprompt(${1:Prompt})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'firetouchinterest(part, player, action)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Fires TouchInterest',
                            insertText: 'firetouchinterest(${1:Part}, ${2:Player}, ${3:1})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'getcallbackvalue(instance, event)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets callback value',
                            insertText: 'getcallbackvalue(${1:inst}, "${2:Activated}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'gethui()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets protected hidden UI',
                            insertText: 'gethui()',
                            range: range
                        },
                        {
                            label: 'getinstances()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets all instances',
                            insertText: 'getinstances()',
                            range: range
                        },
                        {
                            label: 'getnilinstances()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets nil instances',
                            insertText: 'getnilinstances()',
                            range: range
                        },
                        {
                            label: 'getrawmetatable(obj)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets raw metatable',
                            insertText: 'getrawmetatable(${1:obj})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'isreadonly(table)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Checks if table is readonly',
                            insertText: 'isreadonly(${1:tbl})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'isnewcclosure(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Checks if func is a newcclosure',
                            insertText: 'isnewcclosure(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'isfunctionhooked(func)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Checks if func is hooked',
                            insertText: 'isfunctionhooked(${1:func})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'setrawmetatable(obj, mt)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Sets raw metatable',
                            insertText: 'setrawmetatable(${1:obj}, ${2:mt})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'setreadonly(table, state)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Sets table readonly state',
                            insertText: 'setreadonly(${1:tbl}, ${2:true})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'identifyexecutor()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets executor name',
                            insertText: 'identifyexecutor()',
                            range: range
                        },
                        {
                            label: 'gethiddenproperty(obj, prop)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets hidden property',
                            insertText: 'gethiddenproperty(${1:obj}, "${2:Position}")',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'getthreadidentity(thread)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets thread identity',
                            insertText: 'getthreadidentity(${1:thread})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'sethiddenproperty(obj, prop, value)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Sets hidden property',
                            insertText: 'sethiddenproperty(${1:obj}, "${2:prop}", ${3:value})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'setscriptable(bool)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Enables scriptable properties',
                            insertText: 'setscriptable(${1:true})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'setthreadidentity(thread, identity)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Sets thread identity',
                            insertText: 'setthreadidentity(${1:thread}, ${2:7})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'getcallingscript()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets calling script',
                            insertText: 'getcallingscript()',
                            range: range
                        },
                        {
                            label: 'getloadedmodules()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets loaded modules',
                            insertText: 'getloadedmodules()',
                            range: range
                        },
                        {
                            label: 'getrunningscripts()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets running scripts',
                            insertText: 'getrunningscripts()',
                            range: range
                        },
                        {
                            label: 'getscriptbytecode(script)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets bytecode of script',
                            insertText: 'getscriptbytecode(${1:script})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'getscriptclosure(script)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets closure of script',
                            insertText: 'getscriptclosure(${1:script})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'getscripthash(script)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets script hash',
                            insertText: 'getscripthash(${1:script})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'getscripts()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets all scripts',
                            insertText: 'getscripts()',
                            range: range
                        },
                        {
                            label: 'getsenv(script)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets script environment',
                            insertText: 'getsenv(${1:script})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'loadstring(code, env)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Loads a string with an optional chunkname',
                            insertText: 'loadstring("${1:code}", ${2:getgenv()})()',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'firesignal(signal, ...)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Fires a signal',
                            insertText: 'firesignal(${1:BindableEvent}, ${2:...})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'defersignal(signal)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Defers a signal',
                            insertText: 'defersignal(${1:BindableEvent})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'getconnections(signal)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Gets all connections to a signal',
                            insertText: 'getconnections(${1:Signal})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'replicatesignal(signal, ...)',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Replicates signal (fire + replicate)',
                            insertText: 'replicatesignal(${1:Signal}, ${2:...})',
                            insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                            range: range
                        },
                        {
                            label: 'printidentity()',
                            kind: monaco.languages.CompletionItemKind.Function,
                            documentation: 'Print current thread identity',
                            insertText: 'printidentity()',
                            range: range
                        }
                    ];

                    const newTestedFunctions = [
                        { name: 'cache.invalidate', desc: 'Invalidates a cached object' },
                        { name: 'cache.iscached', desc: 'Checks if object is cached' },
                        { name: 'cache.replace', desc: 'Replaces a cached object' },
                        { name: 'compareinstances', desc: 'Compares two instances for equality' },
                        { name: 'checkcaller', desc: 'Checks if current script is calling' },
                        { name: 'getcallingscript', desc: 'Gets the calling script' },
                        { name: 'getscriptclosure', aliases: ['getscriptfunction'], desc: 'Gets closure of a script' },
                        { name: 'hookfunction', aliases: ['replaceclosure'], desc: 'Hooks a function' },
                        { name: 'iscclosure', desc: 'Checks if function is a C closure' },
                        { name: 'islclosure', desc: 'Checks if function is a Lua closure' },
                        { name: 'isexecutorclosure', aliases: ['checkclosure', 'isourclosure'], desc: 'Checks if closure is from executor' },
                        { name: 'newcclosure', desc: 'Creates a new C closure' },
                        { name: 'rconsoleclear', aliases: ['consoleclear'], desc: 'Clears the console' },
                        { name: 'rconsolecreate', aliases: ['consolecreate'], desc: 'Creates a new console' },
                        { name: 'rconsoledestroy', aliases: ['consoledestroy'], desc: 'Destroys the console' },
                        { name: 'rconsoleinput', aliases: ['consoleinput'], desc: 'Simulates console input' },
                        { name: 'rconsoleprint', aliases: ['consoleprint'], desc: 'Prints to console' },
                        { name: 'rconsolesettitle', aliases: ['rconsolename', 'consolesettitle'], desc: 'Sets console title' },
                        { name: 'crypt.encrypt', desc: 'Encrypts data' },
                        { name: 'crypt.decrypt', desc: 'Decrypts data' },
                        { name: 'crypt.generatebytes', desc: 'Generates random bytes' },
                        { name: 'crypt.generatekey', desc: 'Generates a 32-byte key' },
                        { name: 'crypt.hash', desc: 'Hashes data with algorithm' },
                        { name: 'debug.getinfo', desc: 'Gets function info' },
                        { name: 'debug.getstack', desc: 'Gets stack value' },
                        { name: 'debug.setstack', desc: 'Sets a stack value' },
                        { name: 'appendfile', desc: 'Appends to a file' },
                        { name: 'delfolder', desc: 'Deletes a folder' },
                        { name: 'listfiles', desc: 'Lists files in directory' },
                        { name: 'dofile', desc: 'Executes a file' },
                        { name: 'isrbxactive', aliases: ['isgameactive'], desc: 'Checks if game is active' },
                        { name: 'mouse1click', desc: 'Clicks left mouse' },
                        { name: 'mouse1press', desc: 'Presses left mouse' },
                        { name: 'mouse1release', desc: 'Releases left mouse' },
                        { name: 'mouse2click', desc: 'Clicks right mouse' },
                        { name: 'mouse2press', desc: 'Presses right mouse' },
                        { name: 'mouse2release', desc: 'Releases right mouse' },
                        { name: 'mousemoveabs', desc: 'Moves mouse to absolute position' },
                        { name: 'mousemoverel', desc: 'Moves mouse relative' },
                        { name: 'mousescroll', desc: 'Scrolls mouse' },
                        { name: 'fireclickdetector', desc: 'Fires a ClickDetector' },
                        { name: 'getcallbackvalue', desc: 'Gets callback from instance' },
                        { name: 'getconnections', desc: 'Gets signal connections' },
                        { name: 'getcustomasset', desc: 'Gets custom asset URL' },
                        { name: 'gethiddenproperty', desc: 'Gets hidden property' },
                        { name: 'sethiddenproperty', desc: 'Sets hidden property' },
                        { name: 'gethui', desc: 'Gets highest ZIndex GUI' },
                        { name: 'getinstances', desc: 'Gets all instances' },
                        { name: 'getnilinstances', desc: 'Gets nil-parented instances' },
                        { name: 'isscriptable', desc: 'Checks if property is scriptable' },
                        { name: 'setscriptable', desc: 'Sets scriptable state' },
                        { name: 'setrbxclipboard', desc: 'Sets clipboard (Roblox)' },
                        { name: 'getrawmetatable', desc: 'Gets raw metatable' },
                        { name: 'hookmetamethod', desc: 'Hooks a metamethod' },
                        { name: 'getnamecallmethod', desc: 'Gets current namecall method' },
                        { name: 'isreadonly', desc: 'Checks if table is readonly' },
                        { name: 'setrawmetatable', desc: 'Sets raw metatable' },
                        { name: 'setreadonly', desc: 'Sets readonly state' },
                        { name: 'identifyexecutor', aliases: ['getexecutorname'], desc: 'Gets executor name' },
                        { name: 'lz4compress', desc: 'Compresses data with LZ4' },
                        { name: 'lz4decompress', desc: 'Decompresses LZ4 data' },
                        { name: 'messagebox', desc: 'Shows a message box' },
                        { name: 'queue_on_teleport', aliases: ['queueonteleport'], desc: 'Queues script on teleport' },
                        { name: 'request', aliases: ['http.request', 'http_request'], desc: 'Makes HTTP request' },
                        { name: 'setclipboard', aliases: ['toclipboard'], desc: 'Sets system clipboard' },
                        { name: 'setfpscap', desc: 'Sets FPS cap' },
                        { name: 'getgc', desc: 'Gets garbage collected objects' },
                        { name: 'getgenv', desc: 'Gets global environment' },
                        { name: 'getloadedmodules', desc: 'Gets loaded ModuleScripts' },
                        { name: 'getrenv', desc: 'Gets remote environment' },
                        { name: 'getrunningscripts', desc: 'Gets running scripts' },
                        { name: 'getscriptbytecode', aliases: ['dumpstring'], desc: 'Gets script bytecode' },
                        { name: 'getscripthash', desc: 'Gets script hash' },
                        { name: 'getscripts', desc: 'Gets all scripts' },
                        { name: 'getsenv', desc: 'Gets script environment' },
                        { name: 'getthreadidentity', aliases: ['getidentity', 'getthreadcontext'], desc: 'Gets thread identity' },
                        { name: 'setthreadidentity', aliases: ['setidentity', 'setthreadcontext'], desc: 'Sets thread identity' },
                        { name: 'Drawing', desc: 'Drawing class' },
                        { name: 'Drawing.new', desc: 'Creates a new Drawing' },
                        { name: 'Drawing.Fonts', desc: 'Font enum for Drawing' },
                        { name: 'isrenderobj', desc: 'Checks if object is a render object' },
                        { name: 'getrenderproperty', desc: 'Gets render property' },
                        { name: 'setrenderproperty', desc: 'Sets render property' },
                        { name: 'cleardrawcache', desc: 'Clears drawing cache' },
                        { name: 'WebSocket', desc: 'WebSocket class' },
                        { name: 'WebSocket.connect', desc: 'Connects to WebSocket server' }
                    ];

                    const allNewSuggestions = [];
                    newTestedFunctions.forEach(func => {
                        const names = [func.name, ...(func.aliases || [])].filter(name => typeof name === 'string' && name.trim() !== '');
                        names.forEach(name => {
                            allNewSuggestions.push({
                                label: name.includes('(') ? name : `${name}()`,
                                insertText: name.includes('(') ? name : `${name}($0)`,
                                detail: func.desc,
                                documentation: func.desc,
                                kind: monaco.languages.CompletionItemKind.Function,
                                insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
                                range: range
                            });
                        });
                    });

                    const existingLabels = new Set(existingSuggestions.map(s => s.label));
                    const filteredNewSuggestions = allNewSuggestions
                        .filter(s => !existingLabels.has(s.label))
                        .map(s => ({
                            ...s,
                            range: range
                        }));

                    return {
                        suggestions: [
                            ...luaSnippets,
                            ...existingSuggestions,
                            ...filteredNewSuggestions,
                            ...variableSuggestions
                        ]
                    };
                }
            });

            const tabBar = document.getElementById('tab-bar');
            const container = document.getElementById('container');
            const newTabBtn = document.getElementById('new-tab-btn');
            let editors = [];
            let activeTab = null;

        
            function loadTabs() {
                const savedTabs = localStorage.getItem('monacoEditorTabs');
                if (savedTabs) {
                    const tabsData = JSON.parse(savedTabs);
                    tabsData.forEach((tabData, index) => {
                        const tab = createTab(tabData.name);
                        const editor = createEditor(tab);
                        editor.setValue(tabData.content);
                        if (index === 0) switchTab(tab);
                    });
                } else {
                    const firstTab = createTab('Tab 1');
                    createEditor(firstTab);
                    switchTab(firstTab);
                }
            }
            function save() {
                const tabsData = editors.map(editor => ({
                    id: editor.tab.dataset.tabId,
                    name: editor.tab.querySelector('span').textContent,
                    content: editor.editor.getValue()
                }));
                localStorage.setItem('monacoEditorTabs', JSON.stringify(tabsData));
            } 
            function createTab(name) {
                const tabId = `tab-${editors.length}`;
                const tab = document.createElement('div');
                tab.className = 'tab';
                tab.dataset.tabId = tabId;

                const tabLabel = document.createElement('span');
                tabLabel.textContent = name;
                tab.appendChild(tabLabel);

                const closeBtn = document.createElement('button');
                closeBtn.className = 'close-btn';
                closeBtn.textContent = '';
                closeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    closeTab(tab);
                });
                tab.appendChild(closeBtn);

                tab.addEventListener('click', () => {
                    if (activeTab !== tab) {
                        switchTab(tab);
                    }
                });

                tab.addEventListener('dblclick', () => {
                    if (tab.querySelector('.rename-input')) return;
                    const input = document.createElement('input');
                    input.className = 'rename-input';
                    input.value = tabLabel.textContent;
                    input.style.opacity = '0';
                    tabLabel.style.display = 'none';
                    tab.insertBefore(input, closeBtn);
                    setTimeout(() => {
                        input.style.opacity = '1';
                        input.focus();
                    }, 0);
                    input.addEventListener('blur', () => {
                        input.style.opacity = '0';
                        setTimeout(() => {
                            tabLabel.textContent = input.value || `Tab ${editors.length + 1}`;
                            tabLabel.style.display = 'inline';
                            if (tab.contains(input)) tab.removeChild(input);
                            saveTabs();
                        }, 150);
                    });
                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') input.blur();
                    });
                });

                tabBar.insertBefore(tab, newTabBtn);
                save();
                return tab;
            }

            function createEditor(tab) {
                const editorContainer = document.createElement('div');
                editorContainer.id = `editor-${editors.length}`;
                editorContainer.className = 'editor-container';
                container.appendChild(editorContainer);

                const editor = monaco.editor.create(editorContainer, {
                    suggest: {
                        showKeywords: true,
                        showFunctions: true,
                        showMethods: true,
                        showValues: true,
                        showVariables: true,
                        insertMode: 'insert',
                        preview: true,
                        previewMode: 'inline'
                    },
                    value: [
                        ''
                    ].join('\n'),
                    language: 'lua',
                    theme: 'smooth-dark',
                    fontSize: 14,
                    fontFamily: 'JetBrains Mono, Consolas, monospace',
                    fontWeight: 'normal',
                    lineHeight: 22,
                    cursorBlinking: 'smooth',
                    smoothScrolling: true,
                    mouseWheelSmoothScroll: true,
                    cursorSmoothCaretAnimation: true,
                    scrollBeyondLastLine: false,
                    automaticLayout: true,
                    minimap: { enabled: false },
                    lineNumbers: (ln) => ` ${ln} `,
                    glyphMargin: true,
                    roundedSelection: false,
                    contextmenu: false,
                    lineNumbersMinChars: 1,
                    lineDecorationsWidth: 0,
                    occurrencesHighlight: false,
                    selectionHighlight: false,
                    overviewRulerBorder: false,
                    overviewRulerLanes: 0,
                    padding: { top: 8 }
                });

                editor.onDidChangeModelContent(() => {
                    clearTimeout(editor.autoSaveTimeout);
                    editor.autoSaveTimeout = setTimeout(save, 1000);
                });

                editors.push({ tab, editor, container: editorContainer });
                return editor;
            }

            function switchTab(tab) {
                if (activeTab === tab) return;

                if (activeTab) {
                    activeTab.classList.remove('active');
                    const prevEditor = editors.find(e => e.tab === activeTab);
                    if (prevEditor) {
                        prevEditor.container.classList.remove('active');
                    }
                }

                activeTab = tab;
                activeTab.classList.add('active');

                const editorData = editors.find(e => e.tab === tab);
                if (editorData) {
                    editorData.container.classList.add('active');
                    setTimeout(() => {
                        editorData.editor.layout();
                        editorData.editor.focus();
                    }, 50);
                }
            }

            function closeTab(tab) {
                const editorData = editors.find(e => e.tab === tab);
                if (!editorData) return;

                editors = editors.filter(e => e.tab !== tab);
                if (editorData.container.parentNode) {
                    container.removeChild(editorData.container);
                }
                if (tab.parentNode) {
                    tabBar.removeChild(tab);
                }

                if (activeTab === tab) {
                    activeTab = null;
                    if (editors.length > 0) {
                        switchTab(editors[0].tab);
                    } else {
                        const newTab = createTab(`Tab 1`);
                        createEditor(newTab);
                        switchTab(newTab);
                    }
                }

                save();
            }

            newTabBtn.addEventListener('click', () => {
                const tab = createTab(`Tab ${editors.length + 1}`);
                createEditor(tab);
                switchTab(tab);
                tabBar.scrollTo({ left: tabBar.scrollWidth, behavior: 'smooth' });
                save();
            });

            loadTabs();

            window.saveTabs = function () {
                save();
            }
            
            window.clearTabs = function () {
                localStorage.removeItem('monacoEditorTabs');
            };

            window.getEditorValue = function () {
                const activeEditor = editors.find(e => e.tab === activeTab);
                return activeEditor ? activeEditor.editor.getValue() : '';
            };

            window.setEditorValue = function (value) {
                function waitForEditor() {
                    return new Promise((resolve) => {
                        function check() {
                            if (editors.length === 0) {
                                const tab = createTab("Tab 1");
                                createEditor(tab);
                                switchTab(tab);
                                setTimeout(check, 50);
                                return;
                            }
                            const activeEditor = editors.find(e => e.tab === activeTab);
                            if (activeEditor && activeEditor.editor) {
                                resolve(activeEditor);
                            } else {
                                setTimeout(check, 50);
                            }
                        }
                        check();
                    });
                }
            
                waitForEditor().then((activeEditor) => {
                    activeEditor.editor.setValue(value);
                    save();
                });
            };



            window.focusEditor = function () {
                const activeEditor = editors.find(e => e.tab === activeTab);
                if (activeEditor) activeEditor.editor.focus();
            };

            if (window.chrome?.webview) {
                window.chrome.webview.postMessage('EditorLoaded');
            }
        });

    </script>
</body>

</html>





















